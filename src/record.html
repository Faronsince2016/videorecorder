<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>视频录制</title>
    <style>
        h5 {
            margin: 10px 0;
        }

        .content {
            width: 100%;
            height: 500px;
            display: flex;
            justify-content: flex-start;
        }

        #video {
            width: 400px;
            height: 340px;
            border: 1px dashed #ccc;
            box-sizing: border-box;
        }

        .img-wrap {
            flex-grow: 1;
            margin-left: 60px;
            overflow: scroll;
        }

        #imgWrap {
            width: 100%;
            min-height: 340px;
            border: 1px dashed #ccc;
        }
    </style>
</head>

<body>
    <div>
        <div class="content">
            <div class="video-wrap">
                <h5>视频显示区域</h5>
                <video id="video">
                    您的设备不支持设备播放组件，请使用其它浏览器访问。
                </video>
            </div>
            <div class="img-wrap">
                <h5>图片预览区域</h5>
                <div class="img-list" id="imgWrap">

                </div>
            </div>
        </div>
        <div class="operation">
            <h5>操作</h5>
            <div class="btn-group">
                <button id="openCamera">打开摄像头</button>
                <button id="closeCamera">关闭摄像头</button>
                <button id="cutPic">截图</button>
                <button id="clearPic">清空所有截图</button>
                <button id="videoCapture">视频录制</button>
                <button id="pause">暂停录制</button>
                <button id="start">开始录制</button>
                <button id="stop">停止录制</button>
                <button id="save">保存录像</button>
            </div>
        </div>
    </div>
    <script>
        var openCamera = document.getElementById('openCamera'), // 打开摄像头
            closeCamera = document.getElementById('closeCamera'), // 关闭摄像头
            cutPic = document.getElementById('cutPic'), // 截图
            clearPic = document.getElementById('clearPic'), // 清空截图
            videoCapture = document.getElementById('videoCapture'), // 录制视频
            pause = document.getElementById('pause'), // 暂停录制
            start = document.getElementById('start'), // 开始录制
            stop = document.getElementById('stop'), // 停止录制
            save = document.getElementById('save'), // 保存录制
            imgWrap = document.getElementById('imgWrap'), // 图片预览
            vedio = document.getElementById('vedio'), // 视频播放组件
            container = {
                video: {
                    width: 480,
                    height: 320
                }
            },
            canvas = getCanVas(),
            context = canvas.getContext('2d'),
            mediaStream;

        //访问用户媒体设备的兼容方法
        function getUserMedia(constrains, success, error) {
            if (navigator.mediaDevices.getUserMedia) {
                //最新标准API
                navigator.mediaDevices.getUserMedia(constrains).then(success).catch(error);
            } else if (navigator.webkitGetUserMedia) {
                //webkit内核浏览器
                navigator.webkitGetUserMedia(constrains).then(success).catch(error);
            } else if (navigator.mozGetUserMedia) {
                //Firefox浏览器
                navagator.mozGetUserMedia(constrains).then(success).catch(error);
            } else if (navigator.getUserMedia) {
                //旧版API
                navigator.getUserMedia(constrains).then(success).catch(error);
            }
        }

        //成功的回调函数
        function success(stream) {
            //兼容webkit内核浏览器
            var CompatibleURL = window.URL || window.webkitURL;
            mediaStream = stream;
            video.width = container.video.width + 40;
            video.height = container.video.height + 20;
            //将视频流设置为video元素的源
            // video.src = CompatibleURL.createObjectURL(stream); // 此处的代码将会报错  解决的办法是将video的srcObject属性指向stream即可
            video.srcObject = stream;
            //播放视频
            video.play();
        }

        //异常的回调函数
        function error(error) {
            console.log("访问用户媒体设备失败：", error.name, error.message);
        }

        // 生成canvas 获取context对象
        function getCanVas() {
            var canvas = document.createElement('canvas');
            canvas.width = container.video.width / 2;
            canvas.height = container.video.height / 2;
            return canvas;
        }

        // 将base64的数据转成Blob对象
        function base64ToBlob(urlData, type) {
            let arr = urlData.split(',');
            let mime = arr[0].match(/:(.*?);/)[1] || type;     // match方法的使用  
            // 去掉url的头，并转化为byte
            let bytes = window.atob(arr[1]);
            // 处理异常,将ascii码小于0的转换为大于0
            let ab = new ArrayBuffer(bytes.length);
            // 生成视图（直接针对内存）：8位无符号整数，长度1个字节
            let ia = new Uint8Array(ab);
            for (let i = 0; i < bytes.length; i++) {
                ia[i] = bytes.charCodeAt(i);
            }
            return new Blob([ab], {
                type: mime
            });
        }


        // 打开摄像头
        openCamera.onclick = function () {
            if (navigator.mediaDevices.getUserMedia || navigator.getUserMedia || navigator.webkitGetUserMedia ||
                navigator.mozGetUserMedia) {
                //调用用户媒体设备，访问摄像头
                getUserMedia(container, success, error);
            } else {
                alert("你的浏览器不支持访问用户媒体设备");
            }
        }

        // 关闭摄像头
        closeCamera.onclick = function () {
            mediaStream.getTracks()[0].stop();
            // video.pause();
            video.src = '';
            video.load(); // 重新加载视频资源  否则将会显示黑色背景
        }

        //截图
        cutPic.onclick = function () {
            //绘制画面
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            let imgData = canvas.toDataURL("image/png");
            let imgBlob = base64ToBlob(imgData);
            let download = document.createElement('a');
            download.download = 'a.png';
            download.href = window.URL.createObjectURL(imgBlob);
            let img = new Image();
            img.onload = function () {
                imgWrap.appendChild(img);
                img.onload = null;
            };
            img.onclick = function () {
                download.click();
            }
            img.src = imgData;
        }

        // 清空所有截图
        clearPic.onclick = function () {
            imgWrap.innerHTML = '';
        }
    </script>


</body>

</html>